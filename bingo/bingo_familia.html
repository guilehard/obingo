<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Multi-Salas</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé±</text></svg>">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #fafafa; margin: 0; padding: 20px; user-select: none; }
        h1 { color: #d32f2f; margin-bottom: 5px; }
        
        /* Status e Sala */
        .info-bar { font-size: 14px; color: #666; margin-bottom: 20px; background: #eee; padding: 5px; border-radius: 5px; display: inline-block;}
        .online { color: green !important; font-weight: bold; }
        .nome-sala { font-weight: bold; color: #007bff; text-transform: uppercase; }

        /* Login (Entrada da Sala) */
        #tela-login { max-width: 300px; margin: 50px auto; }
        input.input-sala { padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box; text-transform: uppercase; text-align: center; margin-bottom: 10px; }
        
        /* Menu */
        .menu { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; }
        .menu button { padding: 12px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; flex: 1; max-width: 150px; transition: 0.2s; }
        .btn-ativo { background: #d32f2f; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transform: scale(1.05); }
        .btn-inativo { background: #e0e0e0; color: #333; }
        
        .tela { display: none; animation: fadeIn 0.5s; }
        .tela.ativa { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* GLOBO */
        .globo {
            font-size: 80px; font-weight: bold; color: white;
            background: #d32f2f; width: 150px; height: 150px;
            line-height: 150px; border-radius: 50%; margin: 20px auto;
            border: 5px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: 0.3s;
        }
        .globo.agitando { animation: tremer 0.5s infinite; background: #ff9800; }
        @keyframes tremer { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }

        .btn-acao { background: #28a745; color: white; padding: 15px 30px; font-size: 20px; border: none; border-radius: 50px; cursor: pointer; width: 80%; max-width: 300px; box-shadow: 0 4px 0 #1e7e34; }
        .btn-acao:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* CARTELA */
        .cartela-container { max-width: 350px; margin: 0 auto; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #d32f2f; color: white; padding: 10px; font-size: 20px; border-radius: 5px 5px 0 0; }
        td { border: 1px solid #ddd; height: 50px; width: 20%; font-size: 22px; cursor: pointer; transition: background 0.3s; position: relative; }
        
        td.marcado-auto { background-color: #ffeb3b; color: #d32f2f; font-weight: bold; }
        td.marcado-manual { border: 3px solid #28a745; }
        td.free { background: #ddd; font-size: 12px; }

        .grid-historico { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; max-width: 400px; margin: 20px auto; }
        .bolinha-hist { font-size: 12px; padding: 5px; background: #eee; border-radius: 4px; color: #ccc; }
        .bolinha-hist.saiu { background: #333; color: #fff; font-weight: bold; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <h1>üé± BINGO</h1>
    
    <div id="barra-status" class="info-bar" style="display:none;">
        Sala: <span id="display-sala" class="nome-sala">--</span> | 
        <span id="status-conexao">Conectando...</span> |
        <a href="#" onclick="sairDaSala()" style="color:red; font-size:12px;">Sair</a>
    </div>

    <div id="tela-login" class="tela ativa">
        <h3>Escolha uma Sala</h3>
        <p style="font-size:14px; color:#666;">Digite um nome para o grupo (Ex: NATAL, FAMILIA, BAR)</p>
        <input type="text" id="input-sala" class="input-sala" placeholder="Nome da Sala">
        <button class="btn-acao" onclick="entrarNaSala()">ENTRAR</button>
    </div>

    <div id="area-jogo" style="display:none;">
        
        <div class="menu">
            <button onclick="mudarTela('jogador')" id="btn-jogador" class="btn-ativo">Minha Cartela</button>
            <button onclick="verificarAcessoAdm()" id="btn-mesa" class="btn-inativo">üîí Mesa (ADM)</button>
        </div>

        <div id="tela-jogador" class="tela ativa">
            <div class="cartela-container">
                <table>
                    <thead><tr><th>B</th><th>I</th><th>N</th><th>G</th><th>O</th></tr></thead>
                    <tbody id="corpo-cartela"></tbody>
                </table>
            </div>
            <br>
            <button onclick="forcarNovaCartela()" style="background:#555; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">Gerar Nova Cartela</button>
        </div>

        <div id="tela-mesa" class="tela">
            <div class="globo" id="globo-numero">--</div>
            <button class="btn-acao" id="btn-sortear" onclick="iniciarSorteioAnimado()">Sortear N√∫mero</button>
            <div style="margin-top: 30px;">
                <button onclick="reiniciarPartidaGlobal()" style="background:#d32f2f; color:white; padding:8px 15px; border:none; border-radius:5px; cursor:pointer;">Reiniciar Jogo (Sala Atual)</button>
            </div>
            <h3 style="margin-top:20px; border-top:1px solid #ddd; padding-top:10px;">Hist√≥rico</h3>
            <div class="grid-historico" id="grid-historico"></div>
        </div>
    </div>

<script>
    // ======================================================
    // ‚ö†Ô∏è COPIE AQUI SEUS DADOS DO FIREBASE ‚ö†Ô∏è
    // ======================================================
    const firebaseConfig = {
        apiKey: "SUA_API_KEY_AQUI", 
        authDomain: "bingofamilia-7a112.firebaseapp.com",
        databaseURL: "https://bingofamilia-7a112-default-rtdb.firebaseio.com",
        projectId: "bingofamilia-7a112",
        storageBucket: "bingofamilia-7a112.appspot.com",
        messagingSenderId: "123456...",
        appId: "1:123456..."
    };
    // ======================================================

    if (typeof firebase === 'undefined') {
        alert("Erro: O Firebase n√£o carregou.");
    } else {
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        var db = firebase.database();
    }

    const SENHA_ADM = "1234";
    let numerosSorteados = [];
    let SALA_ATUAL = null;

    // --- L√ìGICA DE SALAS ---
    function entrarNaSala() {
        let input = document.getElementById('input-sala').value.trim();
        if (!input) { alert("Digite o nome da sala!"); return; }
        
        // Limpa o nome da sala (remove caracteres especiais e deixa mai√∫sculo)
        SALA_ATUAL = input.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
        
        if(SALA_ATUAL.length < 3) { alert("Nome muito curto!"); return; }

        localStorage.setItem('bingo_sala_id', SALA_ATUAL);
        iniciarSistema();
    }

    function sairDaSala() {
        if(confirm("Sair da sala?")) {
            localStorage.removeItem('bingo_sala_id');
            location.reload();
        }
    }

    // Verifica se j√° tem sala salva ao abrir
    window.onload = function() {
        const salaSalva = localStorage.getItem('bingo_sala_id');
        if (salaSalva) {
            document.getElementById('input-sala').value = salaSalva;
            entrarNaSala();
        }
    };

    function iniciarSistema() {
        // Esconde login, mostra jogo
        document.getElementById('tela-login').classList.remove('ativa');
        document.getElementById('area-jogo').style.display = 'block';
        document.getElementById('barra-status').style.display = 'inline-block';
        document.getElementById('display-sala').innerText = SALA_ATUAL;

        // --- CONECTA NO FIREBASE (DENTRO DA SALA ESPEC√çFICA) ---
        // O truque √© adicionar a SALA no caminho do banco: 'bingo/SALA/estado'
        
        db.ref(".info/connected").on("value", function(snap) {
            const statusDiv = document.getElementById('status-conexao');
            if (snap.val() === true) {
                statusDiv.innerText = "Online";
                statusDiv.classList.add('online');
            } else {
                statusDiv.innerText = "Offline";
                statusDiv.classList.remove('online');
            }
        });

        // Escuta APENAS a sala atual
        db.ref('bingo/' + SALA_ATUAL + '/estado').on('value', (snapshot) => {
            const dados = snapshot.val();
            if (dados) {
                numerosSorteados = dados.sorteados || [];
                const ultimo = numerosSorteados.length > 0 ? numerosSorteados[numerosSorteados.length - 1] : '--';
                
                document.getElementById('globo-numero').innerText = ultimo;
                atualizarHistoricoVisual(numerosSorteados);
                verificarCartelaDoJogador(numerosSorteados);
            } else {
                numerosSorteados = [];
                document.getElementById('globo-numero').innerText = '--';
                atualizarHistoricoVisual([]);
                verificarCartelaDoJogador([]);
            }
        });

        // Inicia/Carrega Cartela
        carregarOuGerarCartela();
    }

    // --- MESA ---
    function iniciarSorteioAnimado() {
        if (numerosSorteados.length >= 75) { alert("Bingo encerrado!"); return; }
        const btn = document.getElementById('btn-sortear');
        const globo = document.getElementById('globo-numero');
        
        btn.disabled = true;
        btn.innerText = "Girando...";
        globo.classList.add('agitando');
        
        let interval = setInterval(() => { globo.innerText = Math.floor(Math.random() * 75) + 1; }, 80);
        setTimeout(() => {
            clearInterval(interval);
            globo.classList.remove('agitando');
            realizarSorteioNoBanco();
            btn.disabled = false;
            btn.innerText = "Sortear N√∫mero";
        }, 3000);
    }

    function realizarSorteioNoBanco() {
        let disponiveis = [];
        for(let i=1; i<=75; i++) { if(!numerosSorteados.includes(i)) disponiveis.push(i); }
        if(disponiveis.length === 0) return;
        let indice = Math.floor(Math.random() * disponiveis.length);
        let numero = disponiveis[indice];
        let novaLista = [...numerosSorteados, numero];
        
        // Salva na SALA ATUAL
        db.ref('bingo/' + SALA_ATUAL + '/estado').set({ sorteados: novaLista, data: new Date().toString() });
    }

    function reiniciarPartidaGlobal() {
        if(prompt("Digite ZERA para reiniciar a sala " + SALA_ATUAL + ":") === "ZERA") {
            db.ref('bingo/' + SALA_ATUAL + '/estado').set(null);
        }
    }

    // --- JOGADOR ---
    function desenharTabela(cols) {
        const corpo = document.getElementById('corpo-cartela');
        corpo.innerHTML = '';
        for (let i = 0; i < 5; i++) {
            let tr = document.createElement('tr');
            let nVal = (i === 2) ? 'FREE' : (i > 2 ? cols.n[i-1] : cols.n[i]);
            let valores = [cols.b[i], cols.i[i], nVal, cols.g[i], cols.o[i]];
            valores.forEach(val => {
                let td = document.createElement('td');
                td.innerText = val;
                if(val === 'FREE') td.classList.add('free');
                td.onclick = () => { if(val !== 'FREE') td.classList.toggle('marcado-manual'); }
                tr.appendChild(td);
            });
            corpo.appendChild(tr);
        }
        verificarCartelaDoJogador(numerosSorteados);
    }

    function carregarOuGerarCartela() {
        const cartelaSalva = localStorage.getItem('minha_cartela_v5');
        if (cartelaSalva) {
            desenharTabela(JSON.parse(cartelaSalva));
        } else {
            gerarEGuardarCartela();
        }
    }

    function gerarEGuardarCartela() {
        let cols = {
            b: numsAleatorios(1, 15, 5),
            i: numsAleatorios(16, 30, 5),
            n: numsAleatorios(31, 45, 4),
            g: numsAleatorios(46, 60, 5),
            o: numsAleatorios(61, 75, 5)
        };
        localStorage.setItem('minha_cartela_v5', JSON.stringify(cols));
        desenharTabela(cols);
    }

    function forcarNovaCartela() {
        if(confirm("Gerar nova cartela?")) gerarEGuardarCartela();
    }

    function verificarCartelaDoJogador(listaSorteados) {
        document.querySelectorAll('#corpo-cartela td').forEach(td => {
            let valor = td.innerText;
            if (valor === "FREE") return;
            if (listaSorteados.includes(parseInt(valor))) { td.classList.add('marcado-auto'); } 
            else { td.classList.remove('marcado-auto'); }
        });
    }

    function numsAleatorios(min, max, qtd) {
        let arr = [];
        while(arr.length < qtd){
            let r = Math.floor(Math.random() * (max - min + 1)) + min;
            if(arr.indexOf(r) === -1) arr.push(r);
        }
        return arr;
    }

    // --- UTILIT√ÅRIOS ---
    function atualizarHistoricoVisual(lista) {
        const grid = document.getElementById('grid-historico');
        grid.innerHTML = '';
        for(let i=1; i<=75; i++) {
            let div = document.createElement('div');
            div.className = 'bolinha-hist ' + (lista.includes(i) ? 'saiu' : '');
            div.innerText = i;
            grid.appendChild(div);
        }
    }

    function mudarTela(tipo) {
        document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa'));
        document.getElementById('tela-' + tipo).classList.add('ativa');
        document.getElementById('btn-jogador').className = tipo === 'jogador' ? 'btn-ativo' : 'btn-inativo';
        document.getElementById('btn-mesa').className = tipo === 'mesa' ? 'btn-ativo' : 'btn-inativo';
    }

    function verificarAcessoAdm() {
        if(document.getElementById('tela-mesa').classList.contains('ativa')) return;
        let senha = prompt("Senha da Mesa:");
        if(senha === SENHA_ADM) mudarTela('mesa');
        else if(senha !== null) alert("Senha errada.");
    }

</script>
</body>
</html>

